<app-title-w-line [title]="'Comptes rendu de visites'"></app-title-w-line>
<mat-card appearance="outlined">
  <mat-card-content>
    <div class="filters">
      <mat-form-field>
        <mat-label>Filtre tout</mat-label>
        <input matInput (keyup)="applyFilter($event)" placeholder="Ex. Quercy" #input>
      </mat-form-field>
      <form [formGroup]="filtresForm" class="filters">
        <mat-form-field>
          <mat-label>Region</mat-label>
          <mat-select formControlName="region" multiple>
            @for (reg of regions; track reg) {
              <mat-option [value]="reg">{{ reg }}</mat-option>
            }
          </mat-select>
        </mat-form-field>
        <mat-form-field>
          <mat-label>Departement</mat-label>
          <mat-select formControlName="departement" multiple>
            @for (dep of departements; track dep) {
              <mat-option [value]="dep">{{ dep }}</mat-option>
            }
          </mat-select>
        </mat-form-field>
        <mat-form-field>
          <mat-label>Action</mat-label>
          <mat-select formControlName="action" multiple>
            @for (ac of actions; track ac) {
              <mat-option [value]="ac.action">{{ ac.lib }}</mat-option>
            }
          </mat-select>
        </mat-form-field>
        <mat-form-field>
          <mat-label>Type</mat-label>
          <mat-select formControlName="type" multiple>
            <mat-option [value]="'PROSPE'">Prospect</mat-option>
            <mat-option [value]="'CLIENT'">Client</mat-option>
          </mat-select>
        </mat-form-field>
      </form>
    </div>
  </mat-card-content>
</mat-card>
<div class="elem-trouve-zbi">
  <h3 style="margin: 0"> {{ this.dataSource.filteredData.length }} Élement(s) trouvé(s)</h3>
  <mat-paginator [pageSizeOptions]="[25, 50, 100]" aria-label="Select page of users"></mat-paginator>
</div>
<div class="btn-qui-clc">
  @if (!selection.isEmpty()) {
    <button mat-raised-button class="export" (click)="exportToXsl.exportToXls(this.selection.selected, 'Compte rendu')">Exporter en xls</button>
    <button mat-raised-button class="export" (click)="campagnesService.openCampaignDialog(selection)">Affecter à une campagne</button>
  } @else {
    <button mat-raised-button class="export nope" [disabled]="true">Exporter en xls</button>
    <button mat-raised-button class="export nope" [disabled]="true">Affecter à une campagne</button>
  }
</div>

<table mat-table [dataSource]="this.dataSource" matSort
  class="mat-elevation-z3" matSortDirection="desc"
  matSortActive="dateFormated" multiTemplateDataRows>
  <ng-container matColumnDef="select">
    <th mat-header-cell *matHeaderCellDef>
      <mat-checkbox (change)="$event ? toggleAllRows() : null"
        [checked]="selection.hasValue() && isAllSelected()"
        [indeterminate]="selection.hasValue() && !isAllSelected()"
        [aria-label]="checkboxLabel()">
      </mat-checkbox>
    </th>
    <td mat-cell *matCellDef="let row">
      <mat-checkbox (click)="$event.stopPropagation()"
        (change)="$event ? selection.toggle(row) : null"
        [checked]="selection.isSelected(row)"
        [aria-label]="checkboxLabel(row)">
      </mat-checkbox>
    </td>
  </ng-container>
  <ng-container matColumnDef="dateFormated">
    <th mat-header-cell *matHeaderCellDef mat-sort-header> Date</th>
    <td mat-cell *matCellDef="let row"
      (click)='openInOtherWindow(row.numclient, row.type)'> {{ row.dateFormated | date : 'shortDate' }}
    </td>
  </ng-container>
  <ng-container matColumnDef="user">
    <th mat-header-cell *matHeaderCellDef mat-sort-header> Utilisateur</th>
    <td mat-cell *matCellDef="let row" (click)='openInOtherWindow(row.numclient, row.type)'> {{ row.user }}</td>
  </ng-container>
  <ng-container matColumnDef="action">
    <th mat-header-cell *matHeaderCellDef mat-sort-header> Action</th>
    <td mat-cell *matCellDef="let row" (click)='openInOtherWindow(row.numclient, row.type)'> {{ row.action }}</td>
  </ng-container>
  <ng-container matColumnDef="client">
    <th mat-header-cell *matHeaderCellDef mat-sort-header> Numéro</th>
    <td mat-cell *matCellDef="let row" (click)='openInOtherWindow(row.numclient, row.type)'> {{ row.numclient }}</td>
  </ng-container>
  <ng-container matColumnDef="nom">
    <th mat-header-cell *matHeaderCellDef mat-sort-header> Raison sociale</th>
    <td mat-cell *matCellDef="let row" (click)='openInOtherWindow(row.numclient, row.type)'> {{ row.raison }}</td>
  </ng-container>
  <ng-container matColumnDef="mail">
    <th mat-header-cell *matHeaderCellDef mat-sort-header> Region</th>
    <td mat-cell *matCellDef="let row" (click)='openInOtherWindow(row.numclient, row.type)'> {{ row.region }}</td>
  </ng-container>
  <ng-container matColumnDef="tel">
    <th mat-header-cell *matHeaderCellDef mat-sort-header> Adresse</th>
    <td mat-cell *matCellDef="let row"
      (click)='openInOtherWindow(row.numclient, row.type)'> {{ row.adresse }} {{ row.codepostal }} {{ row.ville }}
    </td>
  </ng-container>
  <ng-container matColumnDef="expand">
    <th mat-header-cell *matHeaderCellDef aria-label="row actions" style="width: 0; padding: 0;">&nbsp;</th>
    <td mat-cell *matCellDef="let element">
    </td>
  </ng-container>
  <ng-container matColumnDef="contact">
    <th mat-header-cell *matHeaderCellDef mat-sort-header> Nom contact</th>
    <td mat-cell *matCellDef="let row" (click)='openInOtherWindow(row.numclient, row.type)'>
      @if (row.contactnom != 'undefined') {
        {{ row.contactnom }}
      }
    </td>
  </ng-container>
  <ng-container matColumnDef="contactmail">
    <th mat-header-cell *matHeaderCellDef mat-sort-header> Mail contact</th>
    <td mat-cell *matCellDef="let row">
      @if (row.contactmail != 'undefined') {
        <a
        [href]="'mailto:' + row.contactmail">{{ row.contactmail }}</a>
      }
    </td>
  </ng-container>
  <ng-container matColumnDef="contacttel">
    <th mat-header-cell *matHeaderCellDef mat-sort-header> Téléphone contact</th>
    <td mat-cell *matCellDef="let row">
      @if (row.contacttel != 'undefined') {
        <a [href]="'tel:' + row.contacttel.split(' ').join('')">{{ row.contacttel }}</a>
      }
    </td>
  </ng-container>
  <ng-container matColumnDef="type">
    <th mat-header-cell *matHeaderCellDef mat-sort-header> Type</th>
    <td mat-cell *matCellDef="let row">{{row.type | ericFaute}}</td>
  </ng-container>

  <ng-container matColumnDef="expandedDetail">
    <td mat-cell *matCellDef="let element; let i = index" [attr.colspan]="displayedColumnsEnBasLa.length">
      <div class="example-element-detail" style="width: 50%">
        <span [innerText]="start(element.texte)"></span>
        @if (element.texte.includes(filterValue)) {
          <span style="font-weight: bold;"><span
          [innerText]="filterValue"></span></span>
        }
        <span [innerText]="end(element.texte)"></span>
      </div>
    </td>
  </ng-container>

  <tr mat-header-row *matHeaderRowDef="displayedColumnsEnBasLa"></tr>
  <tr mat-row *matRowDef="let element; columns: displayedColumnsEnBasLa; let i = index"
    class="example-element-row test">
  </tr>
  <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="example-detail-row"></tr>


  <!--<tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
  <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>-->

  <tr class="mat-row" *matNoDataRow>
    <td class="mat-cell" colspan="4">Pas de résultat pour la recherche "{{ input.value }}"</td>
  </tr>
</table>
